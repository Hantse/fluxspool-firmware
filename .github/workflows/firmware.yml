name: Firmware Build & Upload

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      base_version:
        description: "Base version (ex: 1.4)"
        required: true
        default: "1.4"
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - prod

concurrency:
  group: firmware-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-upload:
    runs-on: ubuntu-latest
    environment: dev

    strategy:
      fail-fast: false
      matrix:
        env: [ gateway, probe ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PlatformIO
        run: pip install platformio

      - name: Generate Auto Version
        id: version
        run: |
          BASE="1.4"
          DATE=$(date -u +"%Y%m%d%H%M")
          SHORT_SHA=$(git rev-parse --short HEAD)
          FULL_SHA=$(git rev-parse HEAD)

          VERSION="$BASE.$DATE+$SHORT_SHA"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "full_sha=$FULL_SHA" >> $GITHUB_OUTPUT

          echo "Generated version: $VERSION"

      - name: Build Firmware
        run: |
          export FW_VERSION="${{ steps.version.outputs.version }}"
          pio run -e "${{ matrix.env }}"

      - name: Upload Firmware (OTA + FULL)
        env:
          API_URL: ${{ secrets.FW_UPLOAD_URL }}
          API_KEY: ${{ secrets.FW_UPLOAD_KEY }}
        run: |
          set -euo pipefail

          API_URL_CLEAN="$(printf "%s" "$API_URL" | tr -d '\r\n\t ')"
          API_KEY_CLEAN="$(printf "%s" "$API_KEY" | tr -d '\r\n\t ')"

          if ! echo "$API_URL_CLEAN" | grep -Eq '^https?://'; then
            echo "‚ùå FW_UPLOAD_URL must start with http:// or https://"
            echo "Got URL length=${#API_URL_CLEAN}"
            exit 1
          fi

          COMMIT="${{ steps.version.outputs.full_sha }}"

          API_URL_CLEAN="$(printf "%s" "$API_URL" | tr -d '\r\n\t ')"
          API_KEY_CLEAN="$(printf "%s" "$API_KEY" | tr -d '\r\n\t ')"

          FINAL_URL="${API_URL_CLEAN}?commit=${COMMIT}&apiKey=${API_KEY_CLEAN}"

          BUILD_DIR=".pio/build/${{ matrix.env }}"

          upload_one () {
            local BIN="$1"
            local KIND="$2"

            if [ ! -f "$BIN" ]; then
              echo "Skip: $BIN not found"
              return 0
            fi

            local SHA
            local SIZE
            SHA=$(sha256sum "$BIN" | awk '{print $1}')
            SIZE=$(stat -c%s "$BIN")

            echo "Uploading $KIND (commit=$COMMIT)"
            curl -f -X POST "$FINAL_URL" \
              -H "Authorization: Bearer $API_KEY_CLEAN" \
              -F "file=@${BIN};type=application/octet-stream" \
              -F "kind=$KIND" \
              -F "version=${{ steps.version.outputs.version }}" \
              -F "board=${{ matrix.env }}" \
              -F "sha256=$SHA" \
              -F "size=$SIZE"
          }

          upload_one "$BUILD_DIR/firmware.bin" "ota"
          upload_one "$BUILD_DIR/full_firmware.bin" "full"